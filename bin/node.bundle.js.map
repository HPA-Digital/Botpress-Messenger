{"version":3,"sources":["webpack:///webpack/bootstrap df7049898c7007f676b1","webpack:///external \"lodash\"","webpack:///./src/outgoing.js","webpack:///./src/db.js","webpack:///external \"bluebird\"","webpack:///./src/users.js","webpack:///./src/index.js","webpack:///./src/messenger.js","webpack:///external \"botpress\"","webpack:///external \"eventemitter2\"","webpack:///external \"crypto\"","webpack:///external \"node-fetch\"","webpack:///external \"body-parser\"","webpack:///./src/incoming.js","webpack:///external \"lru-cache\"","webpack:///./src/umm.js","webpack:///external \"util\"","webpack:///./src/actions.js"],"names":["handlePromise","next","promise","then","res","catch","err","handleText","event","messenger","sendTextMessage","raw","to","message","quick_replies","handleAttachment","sendAttachment","type","url","handleTemplate","sendTemplate","payload","handleTyping","sendTypingIndicator","typing","handleSeen","sendAction","module","exports","text","attachment","template","seen","pending","knex","initialize","Error","createTableIfNotExists","table","string","primary","addAttachment","attachment_id","insert","get","getAttachment","where","select","ret","hasAttachment","count","k","_","require","bp","userId","db","platform","user","dbEntryToProfile","Object","getUserProfile","id","profile","assign","saveUser","profileToDbEntry","getOrFetchUserProfile","users","map","getAllUsers","gender","timezone","locale","picture_url","profile_pic","first_name","last_name","outgoingPending","outgoing","outgoingMiddleware","setValue","args","__id","message_id","timestamp","Date","getTime","mid","method","waitDelivery","waitRead","apply","initializeMessenger","configurator","loadAll","config","Messenger","enabled","logger","warn","connect","updateSettings","error","hostname","defaultHostname","process","env","BOTPRESS_URL","NODE_ENV","match","applicationID","required","default","accessToken","appSecret","verifyToken","enableAllProfileFields","graphVersion","displayGetStarted","greetingMessage","persistentMenu","persistentMenuItems","validation","isArray","v","composerInputDisabled","automaticallyMarkAsRead","targetAudience","targetAudienceOpenToSome","targetAudienceCloseToSome","trustedDomains","autoResponseOption","autoResponseText","autoResponseTextRenderer","autoResponsePostback","paymentTesters","chatExtensionHomeUrl","chatExtensionInTest","chatExtensionShowShareButton","webhookSubscriptionFields","init","middlewares","register","name","order","handler","description","ready","_internal","Promise","EventEmitter","crypto","fetch","bodyParser","normalizeString","str","replace","toUpperCase","setConfig","app","getRouter","auth","test","req","originalUrl","use","json","verify","_verifyRequestSignature","bind","_initWebhook","_setupNewWebhook","_subscribePage","_unsubscribePage","recipientId","quickReplies","options","formattedQuickReplies","_formatQuickReplies","length","sendMessage","buttons","template_type","formattedButtons","_formatButtons","elements","isReusable","isBoolean","is_reusable","attachmentId","action","sendRequest","recipient","sender_action","autoTimeout","timeout","headers","body","JSON","stringify","object_id","object","field","custom_fields","page_id","access_token","_handleFacebookResponse","console","endpoint","log","_handleEvent","token","response","milliseconds","isNaN","Math","min","before","resolve","delay","profileFields","concat","join","home_url","in_test","show_share","show_string","webview_height_ratio","webview_share_button","fields","setting","deleteChatExtensionHomeUrlSetting","settings","createChatExtensionHomeUrlSetting","tester","setting_type","payment_dev_mode_action","payment_testers","createPaymentTesterSetting","sendThreadRequest","deletePaymentTesterSetting","_getPage","value","isGreetingMessageEmpty","isEmpty","composer_input_disabled","call_to_actions","_reformatPersistentMenuItems","audience_type","countries","whitelist","split","blacklist","indexOf","push","testers","messageConfigKeys","keys","reduce","key","update","delete","factory","button","title","reply","content_type","image_url","emit","sender","postback","quick_reply","status","errorMessage","statusText","error_user_title","error_user_msg","finally","query","send","sendStatus","post","data","entry","forEach","messaging","is_echo","broadcastEchoes","_handleQuickReplyEvent","_handleMessageEvent","attachments","_handleAttachmentEvent","_handlePostbackEvent","delivery","read","account_linking","optin","referral","payment","buf","path","signature","hash","expectedHash","createHmac","digest","item","oAuthUrl","callback_url","verify_token","subscribed_fields","messagesCache","max","maxAge","preprocessEvent","has","alreadyProcessed","set","on","e","sendIncoming","att","mConfig","getConfig","renderers","sendToUser","values","includes","mids","watermark","toString","authorization_code","ref","QUICK_REPLY_PAYLOAD","processButtons","blocName","processQuickReplies","isNil","qrs","isString","qr","exec","startsWith","amendButtons","obj","isPlainObject","mapValues","getUserId","substr","processOutgoing","instruction","ins","optionsList","pick","prop","actions","createTemplate","attr","createAttachment","createText","strRep","util","inspect","getTemplates","at","registerConnector","templates","create","reject","r","rj","messageId","toISOString","random","newEvent","_promise","_resolve","_reject","validateUserId","validateText","validateQuickReply","validateQuickReplies","validateTyping","isNumber","validateAttachmentType","toLowerCase","validateUrl","validateTemplatePayload","validatePersistentMenu","element","isNull","createTyping","createSeen","createPersistentMenu","createGreetingText","createGetStarted","createWhitelistedDomains","domains","every"],"mappings":"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","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"C:\\\\Users\\\\AranM\\\\Projects\\\\botpress-10\\\\Botpress-Messenger\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 5);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap df7049898c7007f676b1","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 0\n// module chunks = 0","const handlePromise = (next, promise) => {\r\n  return promise\r\n    .then(res => {\r\n      next()\r\n      return res\r\n    })\r\n    .catch(err => {\r\n      next(err)\r\n      throw err\r\n    })\r\n}\r\n\r\nconst handleText = (event, next, messenger) => {\r\n  return handlePromise(\r\n    next,\r\n    messenger.sendTextMessage(event.raw.to, event.raw.message, event.raw.quick_replies, event.raw)\r\n  )\r\n}\r\n\r\nconst handleAttachment = (event, next, messenger) => {\r\n  return handlePromise(\r\n    next,\r\n    messenger.sendAttachment(event.raw.to, event.raw.type, event.raw.url, event.raw.quick_replies, event.raw)\r\n  )\r\n}\r\n\r\nconst handleTemplate = (event, next, messenger) => {\r\n  return handlePromise(next, messenger.sendTemplate(event.raw.to, event.raw.payload, event.raw))\r\n}\r\n\r\nconst handleTyping = (event, next, messenger) => {\r\n  return handlePromise(next, messenger.sendTypingIndicator(event.raw.to, event.raw.typing))\r\n}\r\n\r\nconst handleSeen = (event, next, messenger) => {\r\n  return handlePromise(next, messenger.sendAction(event.raw.to, 'mark_seen'))\r\n}\r\n\r\nmodule.exports = {\r\n  text: handleText,\r\n  attachment: handleAttachment,\r\n  template: handleTemplate,\r\n  typing: handleTyping,\r\n  seen: handleSeen,\r\n  pending: {}\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/outgoing.js","import { DatabaseHelpers } from 'botpress'\r\n\r\nlet knex = null\r\n\r\nfunction initialize() {\r\n  if (!knex) {\r\n    throw new Error('you must initialize the database before')\r\n  }\r\n\r\n  return DatabaseHelpers(knex)\r\n    .createTableIfNotExists('messenger_attachments', function(table) {\r\n      table.string('url').primary()\r\n      table.string('attachment_id')\r\n    })\r\n    .then()\r\n}\r\n\r\nfunction addAttachment(url, attachment_id) {\r\n  return knex('messenger_attachments')\r\n    .insert({ url, attachment_id })\r\n    .then()\r\n    .get(0)\r\n}\r\n\r\nfunction getAttachment(url) {\r\n  return knex('messenger_attachments')\r\n    .where('url', url)\r\n    .select('attachment_id')\r\n    .then()\r\n    .get(0)\r\n    .then(ret => {\r\n      return ret && ret.attachment_id\r\n    })\r\n}\r\n\r\nfunction hasAttachment(url) {\r\n  return knex('messenger_attachments')\r\n    .where('url', url)\r\n    .count('url as count')\r\n    .then(ret => {\r\n      return ret && ret[0] && (ret[0].count === \"1\" || ret[0].count === 1)\r\n    })\r\n}\r\n\r\nmodule.exports = k => {\r\n  knex = k\r\n  return { initialize, addAttachment, getAttachment, hasAttachment }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/db.js","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 3\n// module chunks = 0","const _ = require('lodash')\r\n\r\nmodule.exports = function(bp, messenger) {\r\n  function profileToDbEntry(profile) {\r\n    return {\r\n      id: /**'facebook:' + */ profile.id,\r\n      //userId: profile.id,\r\n      platform: 'facebook',\r\n      gender: profile.gender,\r\n      timezone: profile.timezone,\r\n      locale: profile.locale,\r\n      picture_url: profile.profile_pic,\r\n      first_name: profile.first_name,\r\n      last_name: profile.last_name\r\n    };\r\n  }\r\n\r\n  function dbEntryToProfile(db) {\r\n    return {\r\n      gender: db.gender,\r\n      timezone: db.timezone,\r\n      locale: db.locale,\r\n      profile_pic: db.picture_url,\r\n      first_name: db.first_name,\r\n      last_name: db.last_name,\r\n      userId: db.userId,\r\n      id: db.id\r\n    };\r\n  }\r\n\r\n  async function getOrFetchUserProfile(userId) {\r\n    const knex = await bp.db.get()\r\n\r\n    const user = await knex('users')\r\n      .where({ platform: 'facebook', userId: userId })\r\n      .then()\r\n      .get(0)\r\n      .then()\r\n\r\n    if (user) {\r\n      return dbEntryToProfile(user)\r\n    }\r\n\r\n    const profile = Object.assign(await messenger.getUserProfile(userId), { id: userId })\r\n    await bp.db.saveUser(profileToDbEntry(profile))\r\n\r\n    return profile\r\n  }\r\n\r\n  async function getAllUsers() {\r\n    const knex = await bp.db.get()\r\n\r\n    const users = await knex('users')\r\n      .where({ platform: 'facebook' })\r\n      .then()\r\n\r\n    return (users || []).map(dbEntryToProfile)\r\n  }\r\n\r\n  return { getOrFetchUserProfile, getAllUsers }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/users.js","import _ from 'lodash'\r\n\r\nimport Messenger from './messenger'\r\nimport outgoing from './outgoing'\r\nimport incoming from './incoming'\r\nimport Users from './users'\r\nimport UMM from './umm'\r\nimport DB from './db'\r\n\r\nlet messenger = null\r\nconst outgoingPending = outgoing.pending\r\n\r\nlet users = null\r\n\r\nconst outgoingMiddleware = (event, next) => {\r\n  if (event.platform !== 'facebook') {\r\n    return next()\r\n  }\r\n\r\n  if (!outgoing[event.type]) {\r\n    return next('Unsupported event type: ' + event.type)\r\n  }\r\n\r\n  const setValue = method => (...args) => {\r\n    if (event.__id && outgoingPending[event.__id]) {\r\n      if (args && args[0] && args[0].message_id) {\r\n        outgoingPending[event.__id].timestamp = new Date().getTime() - 1000\r\n        outgoingPending[event.__id].mid = args[0].message_id\r\n      }\r\n\r\n      if (method === 'resolve' && (event.raw.waitDelivery || event.raw.waitRead)) {\r\n        // We skip setting this value because we wait\r\n      } else {\r\n        outgoingPending[event.__id][method].apply(null, args)\r\n        delete outgoingPending[event.__id]\r\n      }\r\n    }\r\n  }\r\n\r\n  outgoing[event.type](event, next, messenger).then(setValue('resolve'), setValue('reject'))\r\n}\r\n\r\nconst initializeMessenger = async (bp, configurator) => {\r\n  const config = await configurator.loadAll()\r\n\r\n  messenger = new Messenger(bp, config)\r\n  users = Users(bp, messenger)\r\n\r\n  const enabled = config.enabled\r\n\r\n  if (!enabled) {\r\n    return bp.logger.warn('[Messenger] Connection disabled')\r\n  }\r\n\r\n  return messenger\r\n    .connect()\r\n    .then(() => messenger.updateSettings())\r\n    .catch(err => bp.logger.error(err))\r\n}\r\n\r\nlet hostname = []\r\nconst defaultHostname =\r\n  process.env.BOTPRESS_URL && process.env.NODE_ENV === 'production'\r\n    ? (hostname = process.env.BOTPRESS_URL.match(/https:\\/\\/(.*?)\\//)) && hostname[1]\r\n    : ''\r\n\r\nmodule.exports = {\r\n  config: {\r\n    applicationID: { type: 'string', required: true, default: '', env: 'MESSENGER_APP_ID' },\r\n    accessToken: { type: 'string', required: true, default: '', env: 'MESSENGER_ACCESS_TOKEN' },\r\n    appSecret: { type: 'string', required: true, default: '', env: 'MESSENGER_APP_SECRET' },\r\n    verifyToken: { type: 'string', required: false, default: '', env: 'MESSENGER_VERIFY_TOKEN' },\r\n    enabled: { type: 'bool', required: true, default: true },\r\n    enableAllProfileFields: { type: 'bool', required: true, default: false },\r\n    hostname: { type: 'string', required: false, default: defaultHostname, env: 'MESSENGER_HOST' },\r\n\r\n    graphVersion: { type: 'string', required: true, default: '2.12' },\r\n    displayGetStarted: { type: 'bool', required: false, default: true },\r\n    greetingMessage: { type: 'string', required: false, default: 'Default greeting message' },\r\n    persistentMenu: { type: 'bool', required: false, default: false },\r\n    persistentMenuItems: { type: 'any', required: false, default: [], validation: v => _.isArray(v) },\r\n    composerInputDisabled: { type: 'bool', required: false, default: false },\r\n    automaticallyMarkAsRead: { type: 'bool', required: false, default: true },\r\n    targetAudience: { type: 'string', required: true, default: 'openToAll' },\r\n    targetAudienceOpenToSome: { type: 'string', required: false },\r\n    targetAudienceCloseToSome: { type: 'string', required: false },\r\n    trustedDomains: { type: 'any', required: false, default: [], validation: v => _.isArray(v) },\r\n\r\n    autoResponseOption: { type: 'string', required: false, default: 'autoResponseTextRenderer' },\r\n    autoResponseText: { type: 'string', required: false, default: 'Hello, human!' }, // TODO: unused, remove in v11\r\n    autoResponseTextRenderer: { type: 'string', required: false, default: '#builtin_text' },\r\n    autoResponsePostback: { type: 'string', required: false, default: 'YOUR_POSTBACK' },\r\n    paymentTesters: { type: 'any', required: false, default: [], validation: v => _.isArray(v) },\r\n    chatExtensionHomeUrl: { type: 'string', required: false, default: '' },\r\n    chatExtensionInTest: { type: 'bool', required: false, default: true },\r\n    chatExtensionShowShareButton: { type: 'bool', required: false, default: false },\r\n    webhookSubscriptionFields: {\r\n      type: 'any',\r\n      required: true,\r\n      default: [\r\n        'message_deliveries',\r\n        'message_reads',\r\n        'messages',\r\n        'messaging_optins',\r\n        'messaging_postbacks',\r\n        'messaging_referrals'\r\n      ]\r\n    }\r\n  },\r\n\r\n  init: async function(bp) {\r\n    bp.middlewares.register({\r\n      name: 'messenger.sendMessages',\r\n      type: 'outgoing',\r\n      order: 100,\r\n      handler: outgoingMiddleware,\r\n      module: 'botpress-messenger',\r\n      description:\r\n        'Sends out messages that targets platform = messenger.' +\r\n        ' This middleware should be placed at the end as it swallows events once sent.'\r\n    })\r\n\r\n    bp.messenger = {}\r\n\r\n    const knex = await bp.db.get()\r\n    await DB(knex).initialize()\r\n\r\n    UMM(bp) // Initializes Messenger in the UMM\r\n  },\r\n\r\n  ready: async function(bp, config) {\r\n    await initializeMessenger(bp, config)\r\n    incoming(bp, messenger)\r\n    bp.messenger._internal = messenger\r\n  }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","/**\r\n * Messenger\r\n *\r\n * This file contains one class Messenger, which in charge of communication between\r\n * botpress and fb messenger.\r\n *\r\n */\r\n\r\nconst Promise = require('bluebird')\r\nconst EventEmitter = require('eventemitter2')\r\nconst crypto = require('crypto')\r\nconst fetch = require('node-fetch')\r\nconst _ = require('lodash')\r\nconst bodyParser = require('body-parser')\r\n\r\nimport DB from './db'\r\n\r\nfetch.promise = Promise\r\n\r\nconst normalizeString = function(str) {\r\n  return str.replace(/[^a-zA-Z0-9]+/g, '').toUpperCase()\r\n}\r\n\r\nlet db = null\r\n\r\nclass Messenger extends EventEmitter {\r\n  constructor(bp, config) {\r\n    super()\r\n    if (!bp || !config) {\r\n      throw new Error('You need to specify botpress and config')\r\n    }\r\n\r\n    this.setConfig(config)\r\n    this.bp = bp\r\n\r\n    bp.db.get().then(k => {\r\n      db = DB(k)\r\n      db.initialize()\r\n    })\r\n\r\n    this.app = bp.getRouter('botpress-messenger', {\r\n      'bodyParser.json': false,\r\n      auth: req => !/\\/webhook/i.test(req.originalUrl)\r\n    })\r\n\r\n    this.app.use(\r\n      bodyParser.json({\r\n        verify: this._verifyRequestSignature.bind(this)\r\n      })\r\n    )\r\n\r\n    this._initWebhook()\r\n  }\r\n\r\n  setConfig(config) {\r\n    this.config = Object.assign({}, this.config, config)\r\n  }\r\n\r\n  getConfig() {\r\n    return this.config\r\n  }\r\n\r\n  connect() {\r\n    return this._setupNewWebhook().then(() => this._subscribePage())\r\n  }\r\n\r\n  disconnect() {\r\n    return this._unsubscribePage()\r\n  }\r\n\r\n  sendTextMessage(recipientId, text, quickReplies, options) {\r\n    const message = { text }\r\n    const formattedQuickReplies = this._formatQuickReplies(quickReplies)\r\n    if (formattedQuickReplies && formattedQuickReplies.length > 0) {\r\n      message.quick_replies = formattedQuickReplies\r\n    }\r\n    return this.sendMessage(recipientId, message, options)\r\n  }\r\n\r\n  sendButtonTemplate(recipientId, text, buttons, options) {\r\n    const payload = {\r\n      template_type: 'button',\r\n      text\r\n    }\r\n    const formattedButtons = this._formatButtons(buttons)\r\n    payload.buttons = formattedButtons\r\n\r\n    return this.sendTemplate(recipientId, payload, options)\r\n  }\r\n\r\n  sendGenericTemplate(recipientId, elements, options) {\r\n    const payload = {\r\n      template_type: 'generic',\r\n      elements\r\n    }\r\n    return this.sendTemplate(recipientId, payload, options)\r\n  }\r\n\r\n  sendTemplate(recipientId, payload, options) {\r\n    const message = {\r\n      attachment: {\r\n        type: 'template',\r\n        payload\r\n      },\r\n    }\r\n\r\n    const formattedQuickReplies = this._formatQuickReplies(options.quick_replies)\r\n    if (formattedQuickReplies && formattedQuickReplies.length > 0) {\r\n      message.quick_replies = formattedQuickReplies\r\n    }\r\n\r\n    return this.sendMessage(recipientId, message, options)\r\n  }\r\n\r\n  async sendAttachment(recipientId, type, url, quickReplies, options) {\r\n\r\n    const message = {\r\n      attachment: {\r\n        type: type,\r\n        payload: {}\r\n      }\r\n    }\r\n\r\n    if (options.isReusable && _.isBoolean(options.isReusable)) {\r\n      message.attachment.payload.is_reusable = options.isReusable\r\n    }\r\n\r\n    if (options.attachmentId) {\r\n      message.attachment.payload = {\r\n        attachment_id: options.attachmentId\r\n      }\r\n    } else if (options.isReusable && (await db.hasAttachment(url))) {\r\n      const attachmentId = await db.getAttachment(url)\r\n\r\n      message.attachment.payload = {\r\n        attachment_id: attachmentId\r\n      }\r\n    } else {\r\n      message.attachment.payload.url = url\r\n    }\r\n\r\n    const formattedQuickReplies = this._formatQuickReplies(quickReplies)\r\n    if (formattedQuickReplies && formattedQuickReplies.length > 0) {\r\n      message.quick_replies = formattedQuickReplies\r\n    }\r\n\r\n    return this.sendMessage(recipientId, message, options).then(res => {\r\n      //NOTE: ATTACHMENT ID is not returned if that was used as part of dispatch.\r\n      if (res && res.attachment_id) {\r\n        db.addAttachment(url, res.attachment_id)\r\n      }\r\n    })\r\n  }\r\n\r\n  sendAction(recipientId, action) {\r\n    return this.sendRequest({\r\n      recipient: {\r\n        id: recipientId\r\n      },\r\n      sender_action: action\r\n    })\r\n  }\r\n\r\n  sendMessage(recipientId, message, options) {\r\n    const req = () =>\r\n      this.sendRequest({\r\n        recipient: {\r\n          id: recipientId\r\n        },\r\n        message\r\n      })\r\n    if (options && options.typing) {\r\n      const autoTimeout = message && message.text ? 500 + message.text.length * 10 : 1000\r\n      const timeout = typeof options.typing === 'number' ? options.typing : autoTimeout\r\n      return this.sendTypingIndicator(recipientId, timeout).then(req)\r\n    }\r\n\r\n    return req()\r\n  }\r\n\r\n  sendValidationRequest() {\r\n    const applicationID = this.config.applicationID\r\n\tconst accessToken = this.config.accessToken\r\n\r\n    return fetch(`https://graph.facebook.com/v${this.config.graphVersion}/${applicationID}/subscriptions_sample`, {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        object_id: applicationID,\r\n        object: 'page',\r\n        field: 'messages',\r\n        custom_fields: { page_id: applicationID },\r\n        access_token: accessToken\r\n      })\r\n    })\r\n      .then(this._handleFacebookResponse)\r\n\t  .then(res => res.json())\r\n\t  .catch(err => console.error(\"Error sending validation request: \", err))\r\n  }\r\n\r\n  sendRequest(body, endpoint, method) {\r\n    endpoint = endpoint || 'messages'\r\n    method = method || 'POST'\r\n\r\n\tconst url = `https://graph.facebook.com/v${this.config.graphVersion}/me/${endpoint}`\r\n\tconsole.log('SENDING: ', url);\r\n    return fetch(`${url}?access_token=${this.config.accessToken}`, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify(body)\r\n    })\r\n      .then(this._handleFacebookResponse)\r\n      .then(res => res.json())\r\n      .then(json => {\r\n        this._handleEvent('raw_send_request', {\r\n          url,\r\n          token: this.config.accessToken,\r\n          body,\r\n          endpoint,\r\n          method,\r\n          response: json\r\n        })\r\n        return json\r\n\t  })\r\n\t  .catch(err => console.error(`Error sending request (${method} : ${url}):`, err, body))\r\n  }\r\n\r\n  sendThreadRequest(body, method) {\r\n    return this.sendRequest(body, 'thread_settings', method)\r\n  }\r\n\r\n  sendTypingIndicator(recipientId, milliseconds) {\r\n    let timeout = !milliseconds || isNaN(milliseconds) ? 0 : milliseconds\r\n    timeout = Math.min(20000, timeout)\r\n\r\n    if (milliseconds === true) {\r\n      timeout = 1000\r\n    }\r\n\r\n    const before = timeout > 0 ? Promise.resolve(this.sendAction(recipientId, 'typing_on')) : Promise.resolve(true)\r\n\r\n    return before.delay(timeout + 1000).then(() => this.sendAction(recipientId, 'typing_off'))\r\n  }\r\n\r\n  getUserProfile(userId) {\r\n    const token = this.config.accessToken\r\n    const profileFields = ['first_name', 'last_name', 'profile_pic'].concat(\r\n      this.config.enableAllProfileFields ? ['locale', 'timezone', 'gender'] : []\r\n    )\r\n    const url = `https://graph.facebook.com/v${this.config.graphVersion}/${userId}?fields=${profileFields.join(\r\n      ','\r\n    )}&access_token=${token}`\r\n\r\n    return fetch(url)\r\n      .then(this._handleFacebookResponse)\r\n      .then(res => res.json())\r\n      .catch(err => console.error(`Error getting user profile: ${err}`))\r\n  }\r\n\r\n  /**\r\n   * Create the settings to add a new chat extension home url\r\n   *\r\n   * Within the context of this app the \"show_share\" is a boolean\r\n   * but Facebook either wants a\r\n   */\r\n  createChatExtensionHomeUrlSetting(home_url, in_test, show_share) {\r\n    let show_string = 'hide'\r\n    if (show_share == true) {\r\n      show_string = 'show'\r\n    }\r\n\r\n    return {\r\n      home_url: {\r\n        url: home_url,\r\n        webview_height_ratio: 'tall',\r\n        in_test: in_test,\r\n        webview_share_button: show_string\r\n      }\r\n    }\r\n  }\r\n\r\n  deleteChatExtensionHomeUrlSetting() {\r\n    return {\r\n      fields: ['home_url']\r\n    }\r\n  }\r\n\r\n  deleteChatExtensionHomeUrl() {\r\n\tconst setting = this.deleteChatExtensionHomeUrlSetting()\r\n\tconsole.log(\"SETTINGS: \", settings) //TODO: TEST\r\n    return this.sendRequest(setting, 'messenger_profile', 'DELETE')\r\n  }\r\n\r\n  setChatExtensionHomeUrl(home_url, in_test, show_share) {\r\n    const setting = this.createChatExtensionHomeUrlSetting(home_url, in_test, show_share)\r\n    return this.sendRequest(setting, 'messenger_profile', 'POST')\r\n  }\r\n\r\n  // add and delete payment testers from application\r\n  // https://developers.facebook.com/docs/messenger-platform/thread-settings/payment#payment_test_users\r\n  deletePaymentTesterSetting(tester) {\r\n    return {\r\n      setting_type: 'payment',\r\n      payment_dev_mode_action: 'REMOVE',\r\n      payment_testers: [tester]\r\n    }\r\n  }\r\n  createPaymentTesterSetting() {\r\n    return {\r\n      setting_type: 'payment',\r\n      payment_dev_mode_action: 'ADD',\r\n      payment_testers: this.config.paymentTesters\r\n    }\r\n  }\r\n\r\n  setPaymentTesters() {\r\n    if (this.config.paymentTesters.length == 0) {\r\n      return\r\n    }\r\n    const setting = this.createPaymentTesterSetting()\r\n    return this.sendThreadRequest(setting, 'POST')\r\n  }\r\n  deletePaymentTester(tester) {\r\n    const setting = this.deletePaymentTesterSetting(tester)\r\n    return this.sendThreadRequest(setting, 'POST')\r\n  }\r\n\r\n  getPageDetails() {\r\n    return this._getPage()\r\n  }\r\n\r\n  displayGetStarted() {\r\n    if (this.config.displayGetStarted) {\r\n      return { type: 'update', field: { name: 'get_started', value: { payload: 'GET_STARTED' } } }\r\n    }\r\n\r\n    return { type: 'delete', field: { name: 'get_started' } }\r\n  }\r\n\r\n  greetingMessage() {\r\n    const { greetingMessage } = this.config\r\n    const isGreetingMessageEmpty = _.isEmpty(this.config.greetingMessage)\r\n\r\n    if (isGreetingMessageEmpty) {\r\n      return { type: 'delete', field: { name: 'greeting' } }\r\n    }\r\n\r\n    return {\r\n      type: 'update',\r\n      field: {\r\n        name: 'greeting',\r\n        value: [\r\n          {\r\n            locale: 'default',\r\n            text: greetingMessage\r\n          }\r\n        ]\r\n      }\r\n    }\r\n  }\r\n\r\n  persistentMenu() {\r\n    const { composerInputDisabled, persistentMenu, persistentMenuItems } = this.config\r\n\r\n    if (!persistentMenu) {\r\n      return { type: 'delete', field: { name: 'persistent_menu' } }\r\n    }\r\n\r\n    return {\r\n      type: 'update',\r\n      field: {\r\n        name: 'persistent_menu',\r\n        value: [\r\n          {\r\n            // TODO: Support different menus for different locales\r\n            locale: 'default',\r\n            composer_input_disabled: composerInputDisabled,\r\n            call_to_actions: this._formatButtons(this._reformatPersistentMenuItems(persistentMenuItems))\r\n          }\r\n        ]\r\n      }\r\n    }\r\n  }\r\n\r\n  targetAudience() {\r\n    const { targetAudience, targetAudienceOpenToSome, targetAudienceCloseToSome } = this.config\r\n\r\n    switch (targetAudience) {\r\n      case 'openToAll':\r\n        return { type: 'update', field: { name: 'target_audience', value: { audience_type: 'all' } } }\r\n      case 'closeToAll':\r\n        return { type: 'update', field: { name: 'target_audience', value: { audience_type: 'none' } } }\r\n      case 'openToSome':\r\n        return {\r\n          type: 'update',\r\n          field: {\r\n            name: 'target_audience',\r\n            value: {\r\n              audience_type: 'custom',\r\n              countries: {\r\n                whitelist: targetAudienceOpenToSome.split(/, ?/g)\r\n              }\r\n            }\r\n          }\r\n        }\r\n      case 'closeToSome':\r\n        return {\r\n          type: 'update',\r\n          field: {\r\n            name: 'target_audience',\r\n            value: {\r\n              audience_type: 'custom',\r\n              countries: {\r\n                blacklist: targetAudienceCloseToSome.split(/, ?/g)\r\n              }\r\n            }\r\n          }\r\n        }\r\n      default:\r\n        return { type: 'update', field: { name: 'target_audience', value: { audience_type: 'all' } } }\r\n    }\r\n  }\r\n\r\n  chatExtensionHomeUrl() {\r\n    const { chatExtensionHomeUrl, chatExtensionShowShareButton, chatExtensionInTest } = this.config\r\n\r\n    if (!chatExtensionHomeUrl) {\r\n      return { type: 'delete', field: { name: 'home_url' } }\r\n    }\r\n\r\n    return {\r\n      type: 'update',\r\n      field: {\r\n        name: 'home_url',\r\n        value: {\r\n          url: chatExtensionHomeUrl,\r\n          webview_height_ratio: 'tall',\r\n          webview_share_button: chatExtensionShowShareButton ? 'show' : 'hide',\r\n          in_test: chatExtensionInTest\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  trustedDomains() {\r\n    const { trustedDomains, chatExtensionHomeUrl } = this.config\r\n    if (!_.isEmpty(chatExtensionHomeUrl) && trustedDomains.indexOf(chatExtensionHomeUrl) === -1) {\r\n      trustedDomains.push(chatExtensionHomeUrl)\r\n    }\r\n\r\n    if (_.isEmpty(trustedDomains)) {\r\n      return { type: 'next' }\r\n    }\r\n\r\n    return { type: 'update', field: { name: 'whitelisted_domains', value: trustedDomains } }\r\n  }\r\n\r\n  paymentTesters() {\r\n    const { paymentTesters } = this.config\r\n\r\n    return { type: 'update', field: { name: 'payment_settings', value: { testers: paymentTesters } } }\r\n  }\r\n\r\n  updateSettings() {\r\n    const messageConfigKeys = Object.keys(this.config)\r\n\r\n    const profileFields = messageConfigKeys.reduce(\r\n      (settings, key) => {\r\n        if (!this[key]) {\r\n          return settings\r\n        }\r\n\r\n        const { type, field } = this[key]()\r\n\r\n        if (type === 'next') {\r\n          return settings\r\n        }\r\n\r\n        if (type === 'update') {\r\n          settings.update[field.name] = field.value\r\n        }\r\n\r\n        if (type === 'delete') {\r\n          settings.delete.push(field.name)\r\n        }\r\n\r\n        return settings\r\n      },\r\n      { update: {}, delete: [] }\r\n    )\r\n\r\n\tif(profileFields.delete.length > 0){\r\n\t\tconsole.log(\"Fields: \", profileFields.delete)\r\n\t\tthis.sendRequest({ fields: profileFields.delete }, 'messenger_profile', 'DELETE')\r\n\t}\r\n    this.sendRequest(profileFields.update, 'messenger_profile', 'POST')\r\n  }\r\n\r\n  module(factory) {\r\n    return factory.apply(this, [this])\r\n  }\r\n\r\n  _formatButtons(buttons) {\r\n    return (\r\n      buttons &&\r\n      buttons.map(button => {\r\n        if (typeof button === 'string') {\r\n          return {\r\n            type: 'postback',\r\n            title: button,\r\n            payload: 'BUTTON_' + normalizeString(button)\r\n          }\r\n        }\r\n        return button\r\n      })\r\n    )\r\n  }\r\n\r\n  _formatQuickReplies(quickReplies) {\r\n    return (\r\n      quickReplies &&\r\n      quickReplies.map(reply => {\r\n        if (typeof reply === 'string') {\r\n          return {\r\n            content_type: 'text',\r\n            title: reply,\r\n            payload: 'QR_' + normalizeString(reply)\r\n          }\r\n        } else if (reply && reply.title) {\r\n          return {\r\n            content_type: reply.content_type || 'text',\r\n            title: reply.title,\r\n            payload: reply.payload || 'QR_' + normalizeString(reply.title),\r\n            image_url: reply.image_url\r\n          }\r\n        }\r\n        return reply\r\n      })\r\n    )\r\n  }\r\n\r\n  _handleEvent(type, event) {\r\n    this.emit(type, event)\r\n  }\r\n\r\n  _handleMessageEvent(event) {\r\n    const text = event.message.text\r\n    if (!text) {\r\n      return\r\n    }\r\n\r\n    this._handleEvent('message', event)\r\n\r\n    if (event.message && this.config.automaticallyMarkAsRead) {\r\n      this.sendAction(event.sender.id, 'mark_seen')\r\n    }\r\n  }\r\n\r\n  _handleAttachmentEvent(event) {\r\n    this._handleEvent('attachment', event)\r\n\r\n    if (event.message && this.config.automaticallyMarkAsRead) {\r\n      this.sendAction(event.sender.id, 'mark_seen')\r\n    }\r\n  }\r\n\r\n  _handlePostbackEvent(event) {\r\n    const payload = event.postback.payload\r\n    if (payload) {\r\n      this._handleEvent(`postback:${payload}`, event)\r\n    }\r\n    this._handleEvent('postback', event)\r\n  }\r\n\r\n  _handleQuickReplyEvent(event) {\r\n    const payload = event.message.quick_reply && event.message.quick_reply.payload\r\n    if (payload) {\r\n      this._handleEvent(`quick_reply:${payload}`, event)\r\n    }\r\n    this._handleEvent('quick_reply', event)\r\n\r\n    if (event.message && this.config.automaticallyMarkAsRead) {\r\n      this.sendAction(event.sender.id, 'mark_seen')\r\n    }\r\n  }\r\n\r\n  _handleFacebookResponse(res) {\r\n    if (!res) {\r\n      return\r\n    }\r\n\r\n    if (res.status < 400) {\r\n      return res\r\n    }\r\n\r\n    let errorMessage = 'An error has been returned by Facebook API.'\r\n    errorMessage += '\\nStatus: ' + res.status + ' (' + res.statusText + ')'\r\n\r\n    return Promise.resolve(true)\r\n      .then(() => res.json && res.json())\r\n      .then(json => {\r\n        errorMessage += '\\n' + json.error.message\r\n        if (json.error.error_user_title) {\r\n          errorMessage += '\\n' + json.error.error_user_title\r\n          errorMessage += '\\n' + json.error.error_user_msg\r\n        }\r\n      })\r\n      .finally(() => {\r\n        throw new Error(errorMessage)\r\n      })\r\n  }\r\n\r\n  _initWebhook() {\r\n    this.app.get('/webhook', (req, res) => {\r\n      if (req.query['hub.mode'] === 'subscribe' && req.query['hub.verify_token'] === this.config.verifyToken) {\r\n        res.status(200).send(req.query['hub.challenge'])\r\n      } else {\r\n        console.error('Failed validation. Make sure the validation tokens match.')\r\n        res.sendStatus(403)\r\n      }\r\n    })\r\n\r\n    this.app.post('/webhook', (req, res) => {\r\n      const data = req.body\r\n      if (data.object !== 'page') {\r\n        return\r\n      }\r\n\r\n      this._handleEvent('raw_webhook_body', data)\r\n\r\n      // Iterate over each entry. There may be multiple if batched.\r\n      data.entry.forEach(entry => {\r\n        if (entry && !entry.messaging) {\r\n          return\r\n        }\r\n        // Iterate over each messaging event\r\n        entry.messaging.forEach(event => {\r\n          if (event.message && event.message.is_echo && !this.config.broadcastEchoes) {\r\n            return\r\n          }\r\n          if (event.message && event.message.text) {\r\n            if (event.message.quick_reply) {\r\n              this._handleQuickReplyEvent(event)\r\n            } else {\r\n              this._handleMessageEvent(event)\r\n            }\r\n          } else if (event.message && event.message.attachments) {\r\n            this._handleAttachmentEvent(event)\r\n          } else if (event.postback) {\r\n            this._handlePostbackEvent(event)\r\n          } else if (event.delivery) {\r\n            this._handleEvent('delivery', event)\r\n          } else if (event.read) {\r\n            this._handleEvent('read', event)\r\n          } else if (event.account_linking) {\r\n            this._handleEvent('account_linking', event)\r\n          } else if (event.optin) {\r\n            this._handleEvent('optin', event)\r\n          } else if (event.referral) {\r\n            this._handleEvent('referral', event)\r\n          } else if (event.payment) {\r\n            this._handleEvent('payment', event)\r\n          } else {\r\n            console.log('Webhook received unknown event: ', event)\r\n          }\r\n        })\r\n      })\r\n\r\n      // Must send back a 200 within 20 seconds or the request will time out.\r\n      res.sendStatus(200)\r\n    })\r\n  }\r\n\r\n  _verifyRequestSignature(req, res, buf) {\r\n    if (!/^\\/webhook/i.test(req.path)) {\r\n      return\r\n    }\r\n\r\n    const signature = req.headers['x-hub-signature']\r\n    if (!signature) {\r\n      throw new Error(\"Couldn't validate the request signature.\")\r\n    } else {\r\n      const [, hash] = signature.split('=')\r\n      const expectedHash = crypto\r\n        .createHmac('sha1', this.config.appSecret)\r\n        .update(buf)\r\n        .digest('hex')\r\n\r\n      if (hash != expectedHash) {\r\n        throw new Error(\"Couldn't validate the request signature.\")\r\n      }\r\n    }\r\n  }\r\n\r\n  _reformatPersistentMenuItems() {\r\n    if (this.config.persistentMenu && this.config.persistentMenuItems) {\r\n      return this.config.persistentMenuItems.map(item => {\r\n        if (item.value && item.type === 'postback') {\r\n          item.payload = item.value\r\n          delete item.value\r\n        } else if (item.value && item.type === 'url') {\r\n          item.url = item.value\r\n          item.type = 'web_url'\r\n          delete item.value\r\n        }\r\n        return item\r\n      })\r\n    }\r\n  }\r\n\r\n  _setupNewWebhook() {\r\n\r\n\r\n    const oAuthUrl =\r\n      `https://graph.facebook.com/v${this.config.graphVersion}/oauth/access_token` +\r\n      '?client_id=' +\r\n      this.config.applicationID +\r\n      '&client_secret=' +\r\n      this.config.appSecret +\r\n      '&grant_type=client_credentials'\r\n\r\n    const url = `https://graph.facebook.com/v${this.config.graphVersion}/${this.config\r\n      .applicationID}/subscriptions?access_token=`\r\n\r\n\r\n\tif(process.env.NODE_ENV != \"production\"){\r\n\t\tconsole.log(\"Setting up new Webhook\", oAuthUrl, url);\r\n\t}\r\n\r\n\r\n    return fetch(oAuthUrl)\r\n      .then(this._handleFacebookResponse)\r\n      .then(res => res.json())\r\n      .then(json => json.access_token)\r\n      .then(token =>\r\n        fetch(url + token, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            object: 'page',\r\n            callback_url: 'https://' + this.config.hostname + '/api/botpress-messenger/webhook',\r\n            verify_token: this.config.verifyToken,\r\n            fields: this.config.webhookSubscriptionFields\r\n          })\r\n        })\r\n      )\r\n      .then(this._handleFacebookResponse)\r\n\t  .then(res => res.json())\r\n\t  .catch(err => {\r\n\t\t  console.error(\"Error setting up webhook\", err);\r\n\t  })\r\n  }\r\n\r\n  _subscribePage() {\r\n    const url =\r\n      `https://graph.facebook.com/v${this.config.graphVersion}/me/subscribed_apps?access_token=` +\r\n      this.config.accessToken\r\n    const subscribed_fields = [\r\n      'messages',\r\n      'message_deliveries',\r\n      'messaging_referrals',\r\n      'messaging_postbacks',\r\n      'messaging_optins'\r\n    ]\r\n\r\n    return fetch(url, {\r\n      method: 'POST',\r\n      body: JSON.stringify({ subscribed_fields }),\r\n      headers: { 'Content-Type': 'application/json' }\r\n    })\r\n      .then(this._handleFacebookResponse)\r\n      .then(res => res.json())\r\n      .catch(err => console.error(\"Error in Subscribe Page: \", err))\r\n  }\r\n\r\n  _unsubscribePage() {\r\n    const url =\r\n      `https://graph.facebook.com/v${this.config.graphVersion}/me/subscribed_apps?access_token=` +\r\n      this.config.accessToken\r\n\r\n    return fetch(url, { method: 'DELETE' })\r\n      .then(this._handleFacebookResponse)\r\n      .then(res => res.json())\r\n      .catch(err => console.error(\"Error ubsubscribing page: \", err))\r\n  }\r\n\r\n  _getPage() {\r\n    const url = `https://graph.facebook.com/v${this.config.graphVersion}/me/?access_token=` + this.config.accessToken\r\n\r\n    return fetch(url, { method: 'GET' })\r\n      .then(this._handleFacebookResponse)\r\n      .then(res => res.json())\r\n      .catch(err => console.error(\"Error Getting Page: \", err))\r\n  }\r\n}\r\n\r\nmodule.exports = Messenger\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/messenger.js","module.exports = require(\"botpress\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress\"\n// module id = 8\n// module chunks = 0","module.exports = require(\"eventemitter2\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"eventemitter2\"\n// module id = 9\n// module chunks = 0","module.exports = require(\"crypto\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"crypto\"\n// module id = 10\n// module chunks = 0","module.exports = require(\"node-fetch\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"node-fetch\"\n// module id = 11\n// module chunks = 0","module.exports = require(\"body-parser\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"body-parser\"\n// module id = 12\n// module chunks = 0","import LRU from 'lru-cache'\r\n\r\nimport Users from './users'\r\nimport outgoing from './outgoing'\r\nimport _ from 'lodash'\r\n\r\nmodule.exports = (bp, messenger) => {\r\n  const users = Users(bp, messenger)\r\n\r\n  const logger = bp.logger\r\n\r\n  const messagesCache = LRU({\r\n    max: 10000,\r\n    maxAge: 60 * 60 * 1000\r\n  })\r\n\r\n  const preprocessEvent = payload => {\r\n    const userId = payload.sender && payload.sender.id\r\n    const mid = payload.message && payload.message.mid\r\n\r\n    if (mid && !messagesCache.has(mid)) {\r\n      // We already processed this message\r\n      payload.alreadyProcessed = true\r\n    } else {\r\n      // Mark it as processed\r\n      messagesCache.set(mid, true)\r\n    }\r\n\r\n    return users.getOrFetchUserProfile(userId)\r\n  }\r\n\r\n  messenger.on('message', e => {\r\n    preprocessEvent(e).then(profile => {\r\n      // push the message to the incoming middleware\r\n      bp.middlewares.sendIncoming({\r\n        platform: 'facebook',\r\n        type: 'message',\r\n        user: profile,\r\n        text: e.message.text,\r\n        raw: e\r\n      })\r\n    })\r\n  })\r\n\r\n  messenger.on('attachment', e => {\r\n    preprocessEvent(e).then(profile => {\r\n      bp.middlewares.sendIncoming({\r\n        platform: 'facebook',\r\n        type: 'attachments',\r\n        user: profile,\r\n        text: e.message.attachments.length + ' attachments',\r\n        raw: e\r\n      })\r\n      e.message.attachments.forEach(att => {\r\n        bp.middlewares.sendIncoming({\r\n          platform: 'facebook',\r\n          type: att.type,\r\n          user: profile,\r\n          text: att.payload.url ? att.payload.url : JSON.stringify(att.payload),\r\n          raw: att\r\n        })\r\n      })\r\n    })\r\n  })\r\n\r\n  messenger.on('postback', e => {\r\n    preprocessEvent(e).then(async profile => {\r\n      bp.middlewares.sendIncoming({\r\n        platform: 'facebook',\r\n        type: 'postback',\r\n        user: profile,\r\n        text: e.postback.payload,\r\n        raw: e\r\n      })\r\n\r\n      if (e.postback.payload === 'GET_STARTED') {\r\n        const mConfig = messenger.getConfig()\r\n\r\n        if (mConfig.displayGetStarted && mConfig.autoResponseOption == 'autoResponseTextRenderer') {\r\n          try {\r\n            const options = mConfig.autoResponseText ? { text: mConfig.autoResponseText } : {}\r\n\r\n            await bp.renderers.sendToUser(profile.id, mConfig.autoResponseTextRenderer, options)\r\n          } catch (err) {\r\n            logger.warn('unavailable \"autoResponseTextRenderer\"')\r\n          }\r\n        }\r\n\r\n        if (mConfig.displayGetStarted && mConfig.autoResponseOption == 'autoResponsePostback') {\r\n          bp.middlewares.sendIncoming({\r\n            platform: 'facebook',\r\n            type: 'postback',\r\n            user: profile,\r\n            text: mConfig.autoResponsePostback,\r\n            raw: e\r\n          })\r\n        }\r\n      }\r\n    })\r\n  })\r\n\r\n  messenger.on('quick_reply', e => {\r\n    preprocessEvent(e).then(profile => {\r\n      bp.middlewares.sendIncoming({\r\n        platform: 'facebook',\r\n        type: 'quick_reply',\r\n        user: profile,\r\n        text: e.message.quick_reply.payload,\r\n        raw: e\r\n      })\r\n    })\r\n  })\r\n\r\n  messenger.on('delivery', e => {\r\n    _.values(outgoing.pending).forEach(pending => {\r\n      const recipient = pending.event.raw.to\r\n      if (e.sender.id === recipient && pending.event.raw.waitDelivery) {\r\n        if (_.includes(e.delivery.mids, pending.mid)) {\r\n          pending.resolve(e)\r\n          delete outgoing.pending[pending.event.__id]\r\n        }\r\n      }\r\n    })\r\n\r\n    preprocessEvent(e).then(profile => {\r\n      bp.middlewares.sendIncoming({\r\n        platform: 'facebook',\r\n        type: 'delivery',\r\n        user: profile,\r\n        text: e.delivery.watermark.toString(),\r\n        raw: e\r\n      })\r\n    })\r\n  })\r\n\r\n  messenger.on('read', e => {\r\n    _.values(outgoing.pending).forEach(pending => {\r\n      const recipient = pending.event.raw.to\r\n      if (e.sender.id === recipient) {\r\n        if (pending.event.raw.waitRead && pending.timestamp && pending.timestamp <= e.read.watermark) {\r\n          pending.resolve(e)\r\n          delete outgoing.pending[pending.event.__id]\r\n        }\r\n      }\r\n    })\r\n\r\n    preprocessEvent(e).then(profile => {\r\n      bp.middlewares.sendIncoming({\r\n        platform: 'facebook',\r\n        type: 'read',\r\n        user: profile,\r\n        text: e.read.watermark.toString(),\r\n        raw: e\r\n      })\r\n    })\r\n  })\r\n\r\n  messenger.on('account_linking', e => {\r\n    preprocessEvent(e).then(profile => {\r\n      bp.middlewares.sendIncoming({\r\n        platform: 'facebook',\r\n        type: 'account_linking',\r\n        user: profile,\r\n        text: e.account_linking.authorization_code,\r\n        raw: e\r\n      })\r\n    })\r\n  })\r\n\r\n  messenger.on('optin', e => {\r\n    preprocessEvent(e).then(profile => {\r\n      bp.middlewares.sendIncoming({\r\n        platform: 'facebook',\r\n        type: 'optin',\r\n        user: profile,\r\n        text: e.optin.ref,\r\n        raw: e\r\n      })\r\n    })\r\n  })\r\n\r\n  messenger.on('referral', e => {\r\n    preprocessEvent(e).then(profile => {\r\n      bp.middlewares.sendIncoming({\r\n        platform: 'facebook',\r\n        type: 'referral',\r\n        user: profile,\r\n        text: e.referral.ref,\r\n        raw: e\r\n      })\r\n    })\r\n  })\r\n\r\n  messenger.on('payment', e => {\r\n    preprocessEvent(e).then(profile => {\r\n      bp.middlewares.sendIncoming({\r\n        platform: 'facebook',\r\n        type: 'payment',\r\n        text: 'payment',\r\n        user: profile,\r\n        payment: e.payment,\r\n        raw: e\r\n      })\r\n    })\r\n  })\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/incoming.js","module.exports = require(\"lru-cache\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lru-cache\"\n// module id = 14\n// module chunks = 0","import util from 'util'\r\nimport _ from 'lodash'\r\n\r\nimport actions from './actions'\r\n\r\nconst QUICK_REPLY_PAYLOAD = /\\<(.+)\\>\\s(.+)/i\r\n\r\nfunction processButtons(buttons, blocName) {\r\n  return processQuickReplies(buttons, blocName).map(button => {\r\n    if (button.payload && button.title && _.isNil(button.type)) {\r\n      return Object.assign(button, { type: 'postback' })\r\n    }\r\n\r\n    return button\r\n  })\r\n}\r\n\r\nfunction processQuickReplies(qrs, blocName) {\r\n  if (!_.isArray(qrs)) {\r\n    throw new Error('Expected quick_replies to be an array')\r\n  }\r\n\r\n  return qrs.map(qr => {\r\n    if (_.isString(qr) && QUICK_REPLY_PAYLOAD.test(qr)) {\r\n      let [, payload, text] = QUICK_REPLY_PAYLOAD.exec(qr)\r\n\r\n      // <.HELLO> becomes <BLOCNAME.HELLO>\r\n      if (payload.startsWith('.')) {\r\n        payload = blocName + payload\r\n      }\r\n\r\n      return {\r\n        title: text,\r\n        payload: payload.toUpperCase()\r\n      }\r\n    }\r\n\r\n    return qr\r\n  })\r\n}\r\n\r\nfunction amendButtons(obj, blocName) {\r\n  if (!_.isPlainObject(obj)) {\r\n    return obj\r\n  }\r\n\r\n  return _.mapValues(obj, (value, key) => {\r\n    if (_.isPlainObject(value)) {\r\n      return amendButtons(value, blocName)\r\n    } else if (_.isArray(value)) {\r\n      if (key === 'buttons') {\r\n        return amendButtons(processButtons(value, blocName))\r\n      }\r\n      return value.map(v => amendButtons(v, blocName))\r\n    } else {\r\n      return value\r\n    }\r\n  })\r\n}\r\n\r\nfunction getUserId(event) {\r\n  const userId =\r\n    _.get(event, 'user.userId') ||\r\n    _.get(event, 'raw.userId') ||\r\n    _.get(event, 'userId') ||\r\n    _.get(event, 'raw.from') ||\r\n    _.get(event, 'user.id') ||\r\n    _.get(event, 'raw.user.id')\r\n\r\n  if (!userId) {\r\n    throw new Error('Could not find userId in the incoming event.')\r\n  }\r\n\r\n  if (userId.startsWith('facebook:')) {\r\n    return userId.substr('facebook:'.length)\r\n  }\r\n\r\n  return userId\r\n}\r\n\r\nfunction processOutgoing({ event, blocName, instruction }) {\r\n  const ins = Object.assign({}, instruction) // Create a shallow copy of the instruction\r\n\r\n  ////////\r\n  // PRE-PROCESSING\r\n  ////////\r\n\r\n  const optionsList = ['quick_replies', 'waitRead', 'waitDelivery', 'typing', 'tag', '__platformSpecific', 'on', 'isReusable', 'attachmentId']\r\n\r\n  const options = _.pick(instruction, optionsList)\r\n\r\n  for (const prop of optionsList) {\r\n    delete ins[prop]\r\n  }\r\n\r\n  if (options.quick_replies) {\r\n    options.quick_replies = processQuickReplies(options.quick_replies, blocName)\r\n  }\r\n\r\n  /////////\r\n  /// Processing\r\n  /////////\r\n\r\n  if (!_.isNil(instruction.template_type)) {\r\n    const data = amendButtons(ins, blocName)\r\n    return actions.createTemplate(getUserId(event), data, options)\r\n  }\r\n\r\n  for (const attr of ['image', 'audio', 'video', 'file']) {\r\n    if (!_.isNil(instruction[attr])) {\r\n      return actions.createAttachment(getUserId(event), attr, ins[attr], options)\r\n    }\r\n  }\r\n\r\n  if (!_.isNil(instruction.attachment)) {\r\n    return actions.createAttachment(\r\n      getUserId(event),\r\n      instruction.type || instruction.attachment,\r\n      ins.url || instruction.attachment,\r\n      options\r\n    )\r\n  }\r\n\r\n  if (!_.isNil(instruction.text)) {\r\n    return actions.createText(getUserId(event), instruction.text, options)\r\n  }\r\n\r\n  ////////////\r\n  /// POST-PROCESSING\r\n  ////////////\r\n\r\n  // Nothing to post-process yet\r\n\r\n  ////////////\r\n  /// INVALID INSTRUCTION\r\n  ////////////\r\n\r\n  const strRep = util.inspect(instruction, false, 1)\r\n  throw new Error(`Unrecognized instruction on Facebook Messenger in bloc '${blocName}': ${strRep}`)\r\n}\r\n\r\n////////////\r\n/// TEMPLATES\r\n////////////\r\n\r\nfunction getTemplates() {\r\n  return [\r\n    {\r\n      type: 'Text - Single message',\r\n      template: 'block_name_sm:\\n  - Text goes here..'\r\n    },\r\n    {\r\n      type: 'Text - Multiple messages',\r\n      template: 'block_name_mm:\\n  - Text goes here..(1)\\n  - Text goes here..(2)'\r\n    },\r\n    {\r\n      type: 'Text - Random message',\r\n      template: 'block_name_rm:\\n  - text:\\n    - Text goes here..(1)\\n    - Text goes here..(2)'\r\n    },\r\n    {\r\n      type: 'Typing - Message with typing',\r\n      template: 'block_name_bm:\\n  - text: Text goes here..(1)\\n    typing: 1000ms'\r\n    },\r\n    {\r\n      type: 'Text - Quick replies',\r\n      template:\r\n        'block_name_qr:\\n  - text: Text goes here..\\n    quick_replies:\\n    - <POSTBACK_1> Button..(1)\\n    - <POSTBACK_2> Button..(2)'\r\n    },\r\n    {\r\n      type: 'Attachment - Image',\r\n      template: 'block_image:\\n  - on: facebook\\n    image: https://botpress.io/static/img/nobg_primary_black.png'\r\n    },\r\n    {\r\n      type: 'Attachment - Video',\r\n      template: 'block_video:\\n  - on: facebook\\n    video: https://www.youtube.com/watch?v=QIokUU4HAKU'\r\n    },\r\n    {\r\n      type: 'Template - Generic',\r\n      template:\r\n        'block_generic:\\n  - on: facebook\\n    template_type: generic\\n    elements:\\n    - title: Welcome to Botpress\\n      image_url: https://botpress.io/static/img/grey_bg_primary.png\\n      subtitle: This is a great building framework\\n      default_action:\\n      - type: web_url\\n        url: https://botpress.io\\n        messenger_extensions: false\\n        webview_height_ratio: tall\\n        fallback_url: https://botpress.io\\n      buttons:\\n      - <BTN_RANDOM> Random cat videos\\n      - type: postback\\n        title: This button gives the same thing\\n        payload: BTN_RANDOM\\n      - type: web_url\\n        url: https://youtube.com/?q=cats\\n        title: Cats on Youtube'\r\n    },\r\n    {\r\n      type: 'Template - Carousel',\r\n      template:\r\n        'block_carousel:\\n  - on: facebook\\n    template_type: generic\\n    elements:\\n    - title: Welcome to Botpress\\n      image_url: https://botpress.io/static/img/grey_bg_primary.png\\n      subtitle: This is a great building framework\\n      default_action:\\n      - type: web_url\\n        url: https://botpress.io\\n        messenger_extensions: false\\n        webview_height_ratio: tall\\n        fallback_url: https://botpress.io\\n      buttons:\\n      - <BTN_RANDOM> Random cat videos\\n      - type: postback\\n        title: This button gives the same thing\\n        payload: BTN_RANDOM\\n      - type: web_url\\n        url: https://youtube.com/?q=cats\\n        title: Cats on Youtube\\n    - title: Bienvenido a Botpress\\n      image_url: https://botpress.io/static/img/nobg_primary_black.png\\n      subtitle: Este es un gran marco de construcción\\n      default_action:\\n      - type: web_url\\n        url: https://botpress.io\\n        messenger_extensions: false\\n        webview_height_ratio: tall\\n        fallback_url: https://botpress.io\\n      buttons:\\n      - <BTN_RANDOM> Videos de perros al azar\\n      - type: postback\\n        title: Este botón da lo mismo\\n        payload: BTN_RANDOM\\n      - type: web_url\\n        url: https://youtube.com/?q=cats\\n        title: Gatos en Youtube'\r\n    }\r\n  ]\r\n}\r\n\r\nmodule.exports = bp => {\r\n  const [renderers, registerConnector] = _.at(bp, ['renderers', 'renderers.registerConnector'])\r\n\r\n  renderers &&\r\n    registerConnector &&\r\n    registerConnector({\r\n      platform: 'facebook',\r\n      processOutgoing: args => processOutgoing(Object.assign({}, args, { bp })),\r\n      templates: getTemplates()\r\n    })\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/umm.js","module.exports = require(\"util\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"util\"\n// module id = 16\n// module chunks = 0","import _ from 'lodash'\r\nimport Promise from 'bluebird'\r\nimport outgoing from './outgoing'\r\n\r\nconst create = obj => {\r\n  let resolve = null\r\n  let reject = null\r\n  const promise = new Promise((r, rj) => {\r\n    resolve = r\r\n    reject = rj\r\n  })\r\n\r\n  const messageId = new Date().toISOString() + Math.random()\r\n\r\n  const newEvent = Object.assign(\r\n    {\r\n      _promise: promise,\r\n      _resolve: resolve,\r\n      _reject: reject,\r\n      __id: messageId\r\n    },\r\n    obj\r\n  )\r\n\r\n  outgoing.pending[messageId] = {\r\n    event: newEvent,\r\n    resolve: resolve,\r\n    reject: reject\r\n  }\r\n\r\n  return newEvent\r\n}\r\n\r\nconst validateUserId = userId => {\r\n  if (!/[0-9]+/.test(userId)) {\r\n    throw new Error('Invalid userId')\r\n  }\r\n}\r\n\r\nconst validateText = text => {\r\n  if (typeof text !== 'string' || text.length > 640) {\r\n    throw new Error('Text must be a string less than 640 chars.')\r\n  }\r\n}\r\n\r\nconst validateQuickReply = quick_reply => {\r\n  if (typeof quick_reply !== 'string') {\r\n    if (\r\n      !quick_reply ||\r\n      (typeof quick_reply.title !== 'string' &&\r\n        !_.includes(['location', 'user_email', 'user_phone_number'], quick_reply.content_type))\r\n    ) {\r\n      throw new Error(\r\n        'Expected quick_reply to be a string or an object' +\r\n          'with a title or one of these content_types: location, user_email, user_phone_number'\r\n      )\r\n    }\r\n  }\r\n}\r\n\r\nconst validateQuickReplies = quick_replies => {\r\n  if (!_.isArray(quick_replies)) {\r\n    throw new Error('quick_replies must be an array')\r\n  }\r\n\r\n  _.forEach(quick_replies, validateQuickReply)\r\n}\r\n\r\nconst validateTyping = typing => {\r\n  if (!_.isBoolean(typing) && !_.isNumber(typing)) {\r\n    throw new Error('Expected typing to be a boolean of a number')\r\n  }\r\n}\r\n\r\nconst validateAttachmentType = type => {\r\n  if (typeof type !== 'string') {\r\n    throw new Error('Expected attachment type to be a text')\r\n  }\r\n\r\n  if (!_.includes(['image', 'video', 'audio', 'file'], type.toLowerCase())) {\r\n    throw new Error('Invalid attachment type')\r\n  }\r\n}\r\n\r\nconst validateUrl = url => {\r\n  if (typeof url !== 'string') {\r\n    throw new Error('Expected URL to be a string')\r\n  }\r\n}\r\n\r\nconst validateTemplatePayload = payload => {\r\n  if (!_.isPlainObject(payload)) {\r\n    throw new Error('Template payload must be a plain object')\r\n  }\r\n\r\n  if (typeof payload.template_type !== 'string') {\r\n    throw new Error('\"template_type\" must be set')\r\n  }\r\n}\r\n\r\nconst validatePersistentMenu = elements => {\r\n  if (!_.isArray(elements)) {\r\n    throw new Error('Expected elements to be an array')\r\n  }\r\n\r\n  _.forEach(elements, element => {\r\n    if (!_.isPlainObject(element)) {\r\n      throw new Error('Expected element to be a plain object')\r\n    }\r\n  })\r\n}\r\n\r\nconst createText = (userId, text, options) => {\r\n  validateUserId(userId)\r\n  validateText(text)\r\n\r\n  if (options && options.quick_replies) {\r\n    validateQuickReplies(options.quick_replies)\r\n  }\r\n\r\n  if (options && options.typing) {\r\n    validateTyping(options.typing)\r\n  }\r\n\r\n  return create({\r\n    platform: 'facebook',\r\n    type: 'text',\r\n    text: text,\r\n    raw: {\r\n      to: userId,\r\n      message: text,\r\n      typing: options && options.typing,\r\n      quick_replies: options && options.quick_replies,\r\n      waitRead: options && options.waitRead,\r\n      waitDelivery: options && options.waitDelivery\r\n    }\r\n  })\r\n}\r\n\r\nconst createAttachment = (userId, type, url, options) => {\r\n  validateUserId(userId)\r\n  validateAttachmentType(type)\r\n\r\n  if (_.isNull(url) && !(options && options.attachmentId)) {\r\n    throw new Error('If URL is null, you must pass an attachment_id on options object')\r\n  } else if (options && options.attachmentId) {\r\n    validateText(options.attachmentId)\r\n  } else {\r\n    validateUrl(url)\r\n  }\r\n\r\n  if (options && options.quick_replies) {\r\n    validateQuickReplies(options.quick_replies)\r\n  }\r\n\r\n  if (options && options.typing) {\r\n    validateTyping(options.typing)\r\n  }\r\n\r\n  return create({\r\n    platform: 'facebook',\r\n    type: 'attachment',\r\n    text: 'Attachment (' + type + ') : ' + url,\r\n    raw: {\r\n      to: userId,\r\n      type: type,\r\n      url: url,\r\n      isReusable: options && options.isReusable,\r\n      attachmentId: options && options.attachmentId,\r\n      typing: options && options.typing,\r\n      quick_replies: options && options.quick_replies,\r\n      waitRead: options && options.waitRead,\r\n      waitDelivery: options && options.waitDelivery\r\n    }\r\n  })\r\n}\r\n\r\nconst createTemplate = (userId, payload, options) => {\r\n  validateUserId(userId)\r\n  validateTemplatePayload(payload)\r\n\r\n  if (options && options.typing) {\r\n    validateTyping(options.typing)\r\n  }\r\n\r\n  return create({\r\n    platform: 'facebook',\r\n    type: 'template',\r\n    text: 'Template (' + payload.template_type + ')',\r\n    raw: {\r\n      to: userId,\r\n      payload: payload,\r\n      typing: options && options.typing,\r\n      quick_replies: options && options.quick_replies,\r\n      waitRead: options && options.waitRead,\r\n      waitDelivery: options && options.waitDelivery\r\n    },\r\n  })\r\n}\r\n\r\nconst createTyping = (userId, typing) => {\r\n  validateUserId(userId)\r\n  validateTyping(typing)\r\n\r\n  return create({\r\n    platform: 'facebook',\r\n    type: 'typing',\r\n    text: 'Typing: ' + typing,\r\n    raw: {\r\n      to: userId,\r\n      typing: typing\r\n    }\r\n  })\r\n}\r\n\r\nconst createSeen = userId => {\r\n  validateUserId(userId)\r\n\r\n  return create({\r\n    platform: 'facebook',\r\n    type: 'seen',\r\n    text: 'Mark as seen',\r\n    raw: {\r\n      to: userId\r\n    }\r\n  })\r\n}\r\n\r\nconst createPersistentMenu = elements => {\r\n  if (!elements) {\r\n    return create({\r\n      platform: 'facebook',\r\n      type: 'persistent_menu',\r\n      text: 'Delete the persistent menu',\r\n      raw: {\r\n        delete: true\r\n      }\r\n    })\r\n  }\r\n\r\n  validatePersistentMenu(elements)\r\n  return create({\r\n    platform: 'facebook',\r\n    type: 'persistent_menu',\r\n    text: 'Set persistent menu: ' + elements.length + ' items',\r\n    raw: {\r\n      delete: false,\r\n      elements: elements\r\n    }\r\n  })\r\n}\r\n\r\nconst createGreetingText = text => {\r\n  if (text && text.length > 160) {\r\n    throw new Error('Greeting text must be less than 160 chars')\r\n  }\r\n\r\n  return create({\r\n    platform: 'facebook',\r\n    type: 'greeting_text',\r\n    text: 'Set greeting text: ' + text,\r\n    raw: {\r\n      text: text\r\n    }\r\n  })\r\n}\r\n\r\nconst createGetStarted = postback => {\r\n  return create({\r\n    platform: 'facebook',\r\n    type: 'get_started',\r\n    text: 'Setting get started button: ' + !!postback,\r\n    raw: {\r\n      enabled: !!postback,\r\n      postback: postback\r\n    }\r\n  })\r\n}\r\n\r\nconst createWhitelistedDomains = domains => {\r\n  if (domains && !_.every(domains, _.isString)) {\r\n    throw new Error('Expected domains to be a list of string')\r\n  }\r\n\r\n  return create({\r\n    platform: 'facebook',\r\n    type: 'whitelisted_domains',\r\n    text: 'Setting whitelisted domains',\r\n    raw: {\r\n      domains: domains\r\n    }\r\n  })\r\n}\r\n\r\nmodule.exports = {\r\n  createText,\r\n  createAttachment,\r\n  createTemplate,\r\n  createTyping,\r\n  createSeen,\r\n  createGetStarted,\r\n  createPersistentMenu,\r\n  createGreetingText,\r\n  createWhitelistedDomains\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/actions.js"],"sourceRoot":""}